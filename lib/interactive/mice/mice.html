<html>
<head ></head>
<body>
    <!-- load in D3 and Chart constructor scripts -->
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script>
        var d4 = d3;
        window.d3 = null;
    </script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.17/d3.min.js"></script>
    <script src="https://d3js.org/d3-timer.v1.min.js"></script>
    <script src="lib/mouseplots.js"></script>
    <script src="lib/mouselineup.js"></script>
    <script src="lib/hist.js"></script>

    <style>
        .row {
          margin: 0.15em 0em; 
        }

        .row:before,
        .row:after {
          content: "";
          display: table;
          clear: both; 
        }

        .row *[class*='col-'] {
          box-sizing: border-box;
          position: relative;
          left: 0;
          float: left;
          min-height: 1px;
          padding: 0em 0.15em; 
        }
        
        .col-05 {
          width: 0.5%; }

        .col-1 {
          width: 1%; }

        .col-2 {
          width: 2%; }

        .col-3 {
          width: 3%; }

        .col-4 {
          width: 4%; }

        .col-5 {
          width: 5%; }

        .col-6 {
          width: 6%; }

        .col-7 {
          width: 7%; }

        .col-8 {
          width: 8%; }

        .col-9 {
          width: 9%; }

        .col-10 {
          width: 10%; }

        .col-11 {
          width: 11%; }

        .col-12 {
          width: 12%; }

        .col-13 {
          width: 13%; }

        .col-14 {
          width: 14%; }

        .col-15 {
          width: 15%; }

        .col-16 {
          width: 16%; }

        .col-17 {
          width: 17%; }

        .col-18 {
          width: 18%; }

        .col-19 {
          width: 19%; }

        .col-20 {
          width: 20%; }

        .col-21 {
          width: 21%; }

        .col-22 {
          width: 22%; }

        .col-23 {
          width: 23%; }

        .col-24 {
          width: 24%; }

        .col-25 {
          width: 25%; }

        .col-26 {
          width: 26%; }

        .col-27 {
          width: 27%; }

        .col-28 {
          width: 28%; }

        .col-29 {
          width: 29%; }

        .col-30 {
          width: 30%; }

        .col-31 {
          width: 31%; }

        .col-32 {
          width: 32%; }

        .col-33 {
          width: 33.33%; }

        .col-34 {
          width: 34%; }

        .col-35 {
          width: 35%; }

        .col-36 {
          width: 36%; }

        .col-37 {
          width: 37%; }

        .col-38 {
          width: 38%; }

        .col-39 {
          width: 39%; }

        .col-40 {
          width: 40%; }

        .col-41 {
          width: 41%; }

        .col-42 {
          width: 42%; }

        .col-43 {
          width: 43%; }

        .col-44 {
          width: 44%; }

        .col-45 {
          width: 45%; }

        .col-46 {
          width: 46%; }

        .col-47 {
          width: 47%; }

        .col-48 {
          width: 48%; }

        .col-49 {
          width: 49%; }

        .col-50 {
          width: 50%; }

        .col-51 {
          width: 51%; }

        .col-52 {
          width: 52%; }

        .col-53 {
          width: 53%; }

        .col-54 {
          width: 54%; }

        .col-55 {
          width: 55%; }

        .col-56 {
          width: 56%; }

        .col-57 {
          width: 57%; }

        .col-58 {
          width: 58%; }

        .col-59 {
          width: 59%; }

        .col-60 {
          width: 60%; }

        .col-61 {
          width: 61%; }

        .col-62 {
          width: 62%; }

        .col-63 {
          width: 63%; }

        .col-64 {
          width: 64%; }

        .col-65 {
          width: 65%; }

        .col-66 {
          width: 66.66%; }

        .col-67 {
          width: 67%; }

        .col-68 {
          width: 68%; }

        .col-69 {
          width: 69%; }

        .col-70 {
          width: 70%; }

        .col-71 {
          width: 71%; }

        .col-72 {
          width: 72%; }

        .col-73 {
          width: 73%; }

        .col-74 {
          width: 74%; }

        .col-75 {
          width: 75%; }

        .col-76 {
          width: 76%; }

        .col-77 {
          width: 77%; }

        .col-78 {
          width: 78%; }

        .col-79 {
          width: 79%; }

        .col-80 {
          width: 80%; }

        .col-81 {
          width: 81%; }

        .col-82 {
          width: 82%; }

        .col-83 {
          width: 83%; }

        .col-84 {
          width: 84%; }

        .col-85 {
          width: 85%; }

        .col-86 {
          width: 86%; }

        .col-87 {
          width: 87%; }

        .col-88 {
          width: 88%; }

        .col-89 {
          width: 89%; }

        .col-90 {
          width: 90%; }

        .col-91 {
          width: 91%; }

        .col-92 {
          width: 92%; }

        .col-93 {
          width: 93%; }

        .col-94 {
          width: 94%; }

        .col-95 {
          width: 95%; }

        .col-96 {
          width: 96%; }

        .col-97 {
          width: 97%; }

        .col-98 {
          width: 98%; }

        .col-99 {
          width: 99%; }

        .col-100 {
          width: 100%; }

        .strong {
            font-weight: bold;
            font-size: 1.1em;
        }

        .btn {
          background: #202020;
          background-image: -webkit-linear-gradient(top, #202020, #001526);
          background-image: -moz-linear-gradient(top, #202020, #001526);
          background-image: -ms-linear-gradient(top, #202020, #001526);
          background-image: -o-linear-gradient(top, #202020, #001526);
          background-image: linear-gradient(to bottom, #202020, #001526);
          -webkit-border-radius: 10;
          -moz-border-radius: 10;
          border-radius: 10px;
          -webkit-box-shadow: 0px 1px 4px #666666;
          -moz-box-shadow: 0px 1px 4px #666666;
          box-shadow: 0px 1px 4px #666666;
          color: #FFF8D0;
          font-size: 16px;
          padding: 6px 12px 6px 12px;
          text-decoration: none;
          max-width: 100%
        }

        .btn:hover {
          background: #404040;
          background-image: -webkit-linear-gradient(top, #404040, #003c69);
          background-image: -moz-linear-gradient(top, #404040, #003c69);
          background-image: -ms-linear-gradient(top, #404040, #003c69);
          background-image: -o-linear-gradient(top, #404040, #003c69);
          background-image: linear-gradient(to bottom, #404040, #003c69);
          text-decoration: none;
        }
        .axis path, .tick line {
            fill: none;
            stroke: #666;
        }
        .y.axis path, .y.axis line {
            display: none;
        }
        .y.axis text {
            display: none;
        }
        .hist-axis text {
            font: 16px sans-serif;
        }
        .bar rect {
            stroke-width:3px;
            stroke: #777;
        }
        .hist-bar rect {
          fill: #FF6699;
        }

        .hist-bar text {
          fill: #202020;
          font: 12px sans-serif;
        }
        .bCont {
            padding: none;
        }

        .girls {
            color: #FF6699;
        }
        .boys {
            color: #66CCff;
        }
        .display-count {
            display: inline-block;
            text-align: center;
            width: 60px;
        }
        #count-girls, #count-boys {
            font-size: 32px;
            font-weight: bold;
        }
        .theProb, .theNum {
            font-weight: bold;
        }
        .pupfield{
            max-width: 40px;
        }
        .probfield {
            max-width: 40px;
        }
        .no-margin {
            margin: none !important;
        }
        .bigger {
            font-size: 20px;
            white-space: nowrap;
        }
    </style>

    <div class="row" style="height: 100px;">
        <div class="col-22 bCont no-margin">
            <button class='btn reset'>Reset</button>
            <button class='btn breedn'>Breed</button>
            <input class='pupfield' type="number" id="npups" value="16" step="1" onchange="pupChange()">
            <span id="count-girls" class="display-count girls">0</span>
            <span id="count-boys" class="display-count boys">0</span>
        </div>
        <div id="mouse" class="col-78 no-margin" style="max-height: 100%;"></div>
    </div>
    
    <div class="row">
        <!-- here's the div our chart will be injected into -->

        <div class="col-50 no-margin"><div id="chart-container" class="no-margin"></div></div>
        <div class="col-30 no-margin">
            <div id="hist" class="no-margin"></div>
            <p>
                The probability of getting <input type="number" class="probfield" id="probCheck" value="15" step="1" onchange="doP()"> or more females out of <span id="pups" class="strong"></span> pups is: <span id="theProb" class="strong bigger"></span>
            </p>
        </div>
        <div class="col-20 no-margin"></div>
    </div>

    <div class="row">
        <div class="col-50">
            <p class="strong">The total number of <span class="strong">girls</span> is <span id="total-girls" class="display-count girls">0</span> &amp; <span class="strong">boys</span> is <span id="total-boys" class="display-count boys">0</span> in <span id="total-litters" class="display-count">0</span> litters.</p>
        </div>
        <div class="col-50">
        </div>
    </div>
    
    
    

    <script>
        //CONSTANTS
        var NPUPS = Number(document.getElementById('npups').value);

        // Functions
        var doReset = function(){
            updateIndex = 1;
            theLineup.clearUse();
            dot_plots.reset();
            hist.reset();
            data.reset();
            //reinit at 0's
            theLineup.setData(data.current);
            dot_plots.setData(data.getPlotData());
            hist.setData(data.getHistData());
            doP();
            updateText();
        }
        var pupChange = function(){
            NPUPS = Number(document.getElementById('npups').value);
            doReset();
            hist.bins = NPUPS+2;
            hist.bounds = [0,NPUPS+1];
            simulate(1);
        }
        var simulate = function(nSims){
            var up = function(){
                theLineup.clearUse();
                theLineup.setData(data.current)
                dot_plots.setData(data.getPlotData())
                hist.setData(data.getHistData())
                doP();
                updateText();
            }
            for (sim=1; sim <= nSims; sim++) {
                data.update(breedMice(NPUPS));
            }
            // update the last time
            up()
        }
        var updateText = function(){
            d4.select("#pups").text(NPUPS)
            var litter = data.current;
            if (litter.length){
                var mps = 0, fps = 0;
                litter.forEach(function(p){
                    mps += Number(p == "Male");
                    fps += Number(p == "Female");
                });
                // Update current counts
                d4.select('#count-girls').html(fps)
                d4.select('#count-boys').html(mps)
            }
            var collection = data.array;
            if (collection.length){
                var males = 0, females = 0;
                collection.forEach(function(ltr){
                    ltr.forEach(function(pup){
                        males += Number(pup == 'Male');
                        females += Number(pup == 'Female');
                    });
                });
                // update totals
                d4.select('#total-girls').html(females)
                d4.select('#total-boys').html(males)
                d4.select('#total-litters').html(collection.length)
            }
        }

        var doP = function(){
            var len = data.array.length;
            var prob = 0;
            var checkVal = document.getElementById('probCheck').value;
            //console.log("check",checkVal)
            counts = data.getHistData();
            counts.forEach(function(a){
                prob += Number(a >= Number(checkVal));
            });
            prob /= (0.00+len);
            //console.log("counts",counts);
            //console.log("prob",prob);
            if (prob > 10**(-4)){
                d4.selectAll('#theProb').text(prob.toFixed(4).toString());
                return
            }
            d4.selectAll('#theProb').html("p &lt; 10<sup>-4</sup>");
        }

        var breedMice = function(nPups) {
            var r=[];
            while(r.length < nPups) {
                r.push( Math.floor(Math.random() * 2) ? 'Female' : 'Male' );
            }
            return r
        }

        //Define a data object
        var Data = function(opts){
            this.current = opts.current || [];
            this.array = [];
            this.tracked = opts.tracked;
            this.plotData = [];

            if (!this.current.length) { return; }
            this.updateCount();
        }
        Data.prototype.update = function(dat){
            this.current = dat;
            this.array.push(dat);
            this.updateCount();
        }
        Data.prototype.reset = function(){
            this.array.length = 0;
            this.current.length = 0;
            this.plotData.length = 0;
        }
        
        Data.prototype.updateCount = function(){
            this.count = this.doCount(this.current)
            this.updatePlotData();
            
        }
        Data.prototype.updatePlotData = function(){
            if (!this.current.length){
                return
            }
            var randomNumbers = d4.range(this.current.length).map(d4.randomBates(3));
            var num, out = [];
            for (num=0; num < this.current.length; num++){
                this.plotData.push( {"group": this.current[num], "val": randomNumbers[num]} )
            }
        }
        Data.prototype.getPlotData = function() {
            if (!this.plotData.length){
                return [{"group": [], "val": []}]
            }
            return this.plotData;
        }
        Data.prototype.getHistData = function(){
            obj = this;
            dat = []
            if (this.current.length){
                this.array.forEach(function(litter){
                    dat.push(obj.doCount(litter));
                })
            }
            
            return dat
        }
        Data.prototype.doCount = function (dat){
            return dat.reduce((a,b) => a+(b === this.tracked), 0);
        }

        // SETUP INITIAL DATA -------------------------------------|
        var data = new Data({
            "current": [],
            "tracked": "Female"
        });
        
        // construct plots
        var theLineup = new mouseLineup(
            {
                'data': data.current,
                'element': document.querySelector('#mouse'),
                'marker': 'lib/mouse.svg',
                'colors': ["#FF6699", "#66CCff"],
                'possibleGroups': ["Female","Male"],
                'iconWidth': 40
            }
        );


        var dot_plots = new Dot_Plots({
            data: data.getPlotData(),
            element: document.querySelector('#chart-container'),
            bins: 36
        });

        var hist = new Hist({
            element: document.querySelector('#hist'),
            data: data.getHistData(),
            bins: NPUPS+2,
            bounds: [0,17],
            margin: {top: 10, right: 10, bottom: 20, left: 10}
        });

        var updateIndex = 1

        
        // CALLBACKS --------------------------------------------|
        // change data on click to something randomly-generated
        d4.selectAll('button.breedn').on('click', function(){
            console.log(updateIndex)
            simulate(1);
            updateIndex++
        });

        d4.select('button.reset').on('click', doReset);

        // redraw chart on each resize
        d4.select(window).on('resize', function(){
            dot_plots.resize();
        });

        //Initialize some stuff in the DOM
        doP();
        updateText();
    </script>
</body>
</html>