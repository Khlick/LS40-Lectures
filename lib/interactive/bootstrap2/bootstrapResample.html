<!DOCTYPE html>
<meta charset="utf-8">
<html>
  <head>
    <style>
      h3, p {
        color: #d3d3d3 !important;
      }
      .centered {
        text-align: center;
      }
      .square {
        opacity: 0.6;
      }
      .square:hover {
        opacity: 1.0;
      }
      .d3-tip {
        font-family: Verdana;
        background: rgba(0, 0, 0, 0.8);
        padding: 8px;
        color: #fff; 
        z-index: 5070;
      }
      .svg-border {
        stroke: #d3d3d3;
        fill: none;
        stroke-width: 2px;
      }
      .btn {
        margin-top: -5px;
        margin-bottom: 10px;
        margin-left: 2px;
      }
      /* syle for svg */
      .axis path, .tick line {
          fill: none;
          stroke: #d3d3d3;
      }
      .y.axis path, .y.axis line {
          display: none;
      }
      .y.axis text {
          display: none;
      }
      .hist-axis text {
          font: 16px sans-serif;
      }
      .bar rect {
          stroke-width: 1px;
          stroke: #d3d3d3;
      }
      #group-one-hist, #group-two-hist .hist-bar rect {
        fill: #9469AD;
      }
      
      #theta-hist .hist-bar rect {
        fill: #FFF8D0;
      }

      .hist-bar text {
        fill: #a2a2a2;
        font: 14px sans-serif;
      }
      .axis--x.hist-axis text {
        fill: #d3d3d3;
        font: 14px sans-serif;
      }
      .axis-x-text {
        fill: #d3d3d3;
        font: 14px sans-serif;
      }
      
      .htext {
        display: inline-block;
        width: 40px;
        white-space: nowrap;
        font-size: 1.1em;
        font-weight: bold;
        color: #d3d3d3;
      }
      .smaller {
        font-size: 0.95em;
      }
      body {
        background: #020202 !important;
      }
    </style>


    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.2/MathJax.js?config=TeX-MML-AM_CHTML'></script>
    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-legend/2.25.4/d3-legend.min.js"></script> -->
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-tip/0.7.1/d3-tip.min.js"></script>
    <script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
    <script src="hist.js"></script>
    <script src="colorbox.js"></script>

  </head>
  <body>
    <div class="container">
      <h3 class="centered">Big-Box Visualization</h3>
      <div class="row">
          <div class="col-md-2">
            <div class="centered">
              <button type="button" class='btn' id="resample">Resample</button><br>
              <p>\(B=\)<input class='short-field' type="number" id="n-boots" min="1" max="10000" value="1" step="1" onchange="nBootsChange()"></p>
              <p>\(\bar{x}_{group1}=\) <span class="htext" style="text-align: center;" !important;" id="group1-mean">0</span><br>
                \(N=\)<input class='short-field' type="number" id="n-g1" min="1" max="25" value="10" step="1" onchange="nGroupChange('group1')"><br></p>
              <p>\(\bar{x}_{group2}=\) <span class="htext" style="text-align: center;" !important;" id="group2-mean">0</span><br>
                \(N=\)<input class='short-field' type="number" id="n-g2" min="1" max="25" value="10" step="1" onchange="nGroupChange('group2')"><br></p>
              <p>\(\Delta_{g1-g2}=\) <span class="htext" style="text-align: center;" !important;" id="theta-mean">0</span></p>
              <p class="smaller">Number of BootStraps:</p>
              <p><span class="htext" style="text-align: center;" !important;" id="total-boots">0</span></p>
              <p class="smaller">2-tailed p-value:</p>
              <p><span class="htext" style="text-align: center;" !important;" id="p-value">-</span></p>
              <button type="button" class='btn' id="reset">Reset</button>
            </div>
          </div>
          <div class="col-md-4">
            <div id="big-box"></div>
          </div>
          <div class="col-md-6">
            <div class="row">
                <div class="col-md-5">
                  <div  id="group-one"></div>
                </div>
                <div class="col-md-7">
                  <div  id="group-one-hist"></div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-5">
                    <div id="group-two"></div>
                </div>
                <div class="col-md-7">
                  <div  id="group-two-hist"></div>
                </div>
            </div>
            <div class="row">
                <div class="col-xs-12">
                  <div  id="theta-hist"></div>
                </div>
            </div>
          </div>
        </div>
    </div>
    
    <script type="text/javascript">
      // DEFINE INITIAL VARIABLES
      var COLORS = ['#88A9C9','#E04B4B'], //blue,red
          MU1 = 110420.7,
          SIGMA1 = 88786.22,
          MU2 = 59531.7,
          SIGMA2 = 37695.6,
          NSAMPLES = 1,
          BOOTCOUNTER = 0;
      
      var N_G1 = Number(document.getElementById('n-g1').value),
          N_G2 = Number(document.getElementById('n-g2').value),
          BINS = [0,0],
          BINS_G1 = [0,0],
          BINS_G2 = [0,0],
          NPTS = N_G1+N_G2;
        
      // FUNCTIONS **************************************************************/
      var makeRect = function(n,maxWidth,maxHeight){
        if (maxWidth === undefined) {
          maxWidth = parseInt(n/2)+1;
        }
        if (maxHeight === undefined) {
          maxHeight = parseInt(n/2)+1;
        }
        var divN = d3.range(2,maxWidth);
        let checkRange = divN.filter(c => parseInt(n/c) == n/c);
        var ww,hh;
        // if not, loop through looking for the best square
        while (ww === undefined && hh === undefined) {
          var w,h;
          if (!checkRange.length) {
            w = maxWidth;
            h = parseInt(n/w);
          } else if (checkRange.length == 1) {
            w = checkRange[0];
            h = parseInt(n/w);
          } else {
            w = parseInt(d3.median(checkRange));//prefer squarer
            h = parseInt(n/w);
          }
          //console.log(w, maxWidth,h, maxHeight)
          if (w > maxWidth || h > maxHeight) {
            // Check if swappable
            if (h <= maxWidth && w <= maxHeight){
              let tmpH = h;
              hh = w;
              ww = tmpH;
              continue;
            }
            checkRange.pop();
            continue;
          }
          ww = w;
          hh = parseInt(n/w);
        }
        //next, check that we have at least n bins
        while (ww*hh < n) {
          //add 1 to hh
          hh += 1;
        }
        
        //return
        return [ww,hh];
      }
      
      var rep = function(arr,times,each){
        if (times == undefined){ times = 1;}
        if (each == undefined) {each = Array.from(new Array(arr.length),(v,i)=>1);}
        if (each.length != arr.length){
          let len = each.length;
          each.length = arr.length;
          each.fill(each[len-1], len);
        }
        // first handle each
        var output = new Array();
        if (!each.every(a => a==1 )) {
          let newLength = each.reduce((t,v) => t+v );
          // force output to new length
          output.length = newLength;
          // get cumulative sum
          var cumsum = [];
          each.reduce((t,v,i) => cumsum[i] = t+v,-1);
          // insert the values into the output array
          cumsum.forEach(function(v,i,a){
            if(!i){
              // is zero index, should run to 0th from cumsum[0]
              for (o=v; o>-1; o--){
                output[o] = arr[i];
              }
            } else {
              // run from the max index of current val down to the previous
              // inserting the current array value in.
              for(o=v; o>a[i-1]; o--) {
                output[o] = arr[i];
              }
            }
          });
        } //end each
        // Now, handle times
        if (times==1){ return output; }
        var repOut = []
        for (var i=0; i < times; i++){
          repOut = repOut.concat(output);
        }
        return repOut;
      }
      
      var resample = function(){
        // resample with replacement
        for (let n = 0; n < NSAMPLES; n++){
          //need to randomize all the same
          var newData = {values:[],groups:[],groupNums:[]}; 
          var g1Data = {values:[],groups:[],groupNums:[]};
          var g2Data = {values:[],groups:[],groupNums:[]};
          //
          BOOTCOUNTER++;
          //group1
          for (let i = 0; i < N_G1; i++){
            let theInd = Math.floor(Math.random() * DATA.values.length);
            g1Data.values.push(DATA.values[theInd]);
            g1Data.groups.push(DATA.groups[theInd]);
            g1Data.groupNums.push(DATA.groupNums[theInd]);
          }
          //group2
          for (let i = 0; i < N_G2; i++){
            let theInd = Math.floor(Math.random() * DATA.values.length);
            g2Data.values.push(DATA.values[theInd]);
            g2Data.groups.push(DATA.groups[theInd]);
            g2Data.groupNums.push(DATA.groupNums[theInd]);
          }
          //update running boots
          BOOTS.group1.push(d3.mean(g1Data.values));
          BOOTS.group2.push(d3.mean(g2Data.values));
          BOOTS.theta.push(d3.mean(g1Data.values)-d3.mean(g2Data.values));
        }
        Object.keys(newData).forEach(function(key){
          newData[key] = newData[key].concat(g1Data[key]);
          newData[key] = newData[key].concat(g2Data[key]);
        });
        
        bigbox.update(newData.groupNums, newData.groups);
        group1.update(g1Data.groupNums, g1Data.groups);
        group2.update(g2Data.groupNums, g2Data.groups);
        
        // Also update hists
        updateHistograms();
        // Update text
        d3.select('#total-boots').html(BOOTCOUNTER);
        updatePvalue();
      }
      
      
      var updateHistograms = function() {
        g1Hist.setData(BOOTS.group1);
        g2Hist.setData(BOOTS.group2);
        thetaHist.setData(BOOTS.theta);
      }
      
      var updatePvalue = function() {
        if (!BOOTCOUNTER) {
          d3.select('#p-value').html('-');
          return;
        }
        var counts = 0;
        if (ACTS.theta > 0){
          BOOTS.theta.reduce(function(v,a){
            if (a >= ACTS.theta) {
              counts++;
            } else if(a <= -ACTS.theta){
              counts++;
            }
          });
        } else {
          BOOTS.theta.reduce(function(v,a){
            if (a <= ACTS.theta) {
              counts++;
            } else if(a >= -ACTS.theta){
              counts++;
            }
          });
        }
        counts /= BOOTCOUNTER;
        
        d3.select('#p-value').html(counts.toFixed(BOOTCOUNTER.toString().length));
      }
      
      var formatMoney = function(number, places, symbol, thousand, decimal) {
        number = number || 0;
        places = !isNaN(places = Math.abs(places)) ? places : 2;
        symbol = symbol !== undefined ? symbol : "$";
        thousand = thousand || ",";
        decimal = decimal || ".";
        var negative = number < 0 ? "-" : "",
            i = parseInt(number = Math.abs(+number || 0).toFixed(places), 10) + "",
            j = (j = i.length) > 3 ? j % 3 : 0;
        return symbol + negative + (j ? i.substr(0, j) + thousand : "") + i.substr(j).replace(/(\d{3})(?=\d)/g, "$1" + thousand) + (places ? decimal + Math.abs(number - i).toFixed(places).slice(2) : "");
      }
      
      // CALLBACKS **************************************************************/
      var nBootsChange = function() {
        NSAMPLES = Number(document.getElementById('n-boots').value);
      }
      
      var nGroupChange = function(group) {
        // get which group and update the global var
        switch (group) {
          case 'group1':
            var newNum = Number(document.getElementById('n-g1').value);
            if (N_G1 == newNum){ return; }
            N_G1 = newNum;
            break;
          case 'group2':
            var newNum = Number(document.getElementById('n-g2').value);
            if (N_G2 == newNum){ return; }
            N_G2 = newNum;
            break;
          default:
            return;
        }
        NPTS = N_G1+N_G2;
        // update data
        DATA = {groups:[], groupNums: [], values: []};
        let tmp1 = d3.range(N_G1).map(d3.randomNormal(0,SIGMA1));
        let t1m = d3.mean(tmp1);
        tmp1 = tmp1.map(v => v-t1m+MU1);
        let tmp2 = d3.range(N_G2).map(d3.randomNormal(0,SIGMA2));
        let t2m = d3.mean(tmp2);
        tmp2 = tmp2.map(v => v-t2m+MU2);
        DATA.values = tmp1.concat(tmp2);
        DATA.groups = rep(['Control', 'Experiment'], times=1, each = [N_G1,N_G2]);
        DATA.groupNums = rep([0,1], times=1, each = [N_G1,N_G2]);
        
        BOOTS = {group1: [], group2: [], theta: []};
        ACTS = {
          group1: d3.mean(DATA.values.slice(0,N_G1)), 
          group2: d3.mean(DATA.values.slice(-N_G2)), 
          theta: d3.mean(DATA.values.slice(0,N_G1))-d3.mean(DATA.values.slice(-N_G2))
        };
        //update everything else
        updateBINS();
        reset();
      }
      
      var updateBINS = function(){
        BINS = makeRect(NPTS);
        BINS_G1 = makeRect(N_G1);
        BINS_G2 = makeRect(N_G2);
      }
      
      var reset = function() {
        BOOTS = {group1: [], group2: [], theta: []};
        //update bindims on boxes
        bigbox.binDim = BINS;
        group1.binDim = BINS_G1;
        group2.binDim = BINS_G2;
        // update box data
        bigbox.update(DATA.groupNums, DATA.groups);
        group1.update(DATA.groupNums.slice(0,N_G1), DATA.groups.slice(0,N_G1));
        group2.update(DATA.groupNums.slice(-N_G2), DATA.groupNums.slice(-N_G2));
        BOOTCOUNTER = 0;
        // reset hists
        g1Hist.reset();
        g2Hist.reset();
        thetaHist.reset();
        // Update text
        d3.select('#total-boots').html(BOOTCOUNTER);
        updatePvalue();
      }
      // assign to buttons:
      d3.select("#resample").on("click", function() { resample(); } );
      d3.select("#reset").on("click", function() { reset(); } );
      // INITIALIZE ***************************************************************/
      // generate some initial data
      
      var DATA = {groups:[], groupNums: [], values: []};
      let tmp1 = d3.range(N_G1).map(d3.randomNormal(0,SIGMA1));
      let t1m = d3.mean(tmp1);
      tmp1 = tmp1.map(v => v-t1m+MU1);
      let tmp2 = d3.range(N_G2).map(d3.randomNormal(0,SIGMA2));
      let t2m = d3.mean(tmp2);
      tmp2 = tmp2.map(v => v-t2m+MU2);
      DATA.values = tmp1.concat(tmp2);
      DATA.groups = rep(['Control', 'Experiment'], times=1, each = [N_G1,N_G2]);
      DATA.groupNums = rep([0,1], times=1, each = [N_G1,N_G2]);
      
      var BOOTS = {group1: [], group2: [], theta: []};
      var ACTS = {
        group1: d3.mean(DATA.values.slice(0,N_G1)), 
        group2: d3.mean(DATA.values.slice(-N_G2)), 
        theta: d3.mean(DATA.values.slice(0,N_G1))-d3.mean(DATA.values.slice(-N_G2))
      };
      
      d3.select('#group1-mean').html(formatMoney(ACTS.group1,0,'$'));
      d3.select('#group2-mean').html(formatMoney(ACTS.group2,0,'$'));
      d3.select('#theta-mean').html(formatMoney(ACTS.theta,0,'$'));
      d3.select('#total-boots').html(BOOTCOUNTER);
      
      BINS = makeRect(NPTS);
      var BINS_G1 = makeRect(N_G1, undefined, 2);
      var BINS_G2 = makeRect(N_G2, undefined, 2);
      
      // CONSTRUCT OBJECTS ******************************************************/
      var bigbox = new ColorBox({
        data: DATA.groupNums, 
        dataLabels: DATA.groups,
        element: document.querySelector("#big-box"),
        targetDims: {width: 300, height: 600},
        binDim: BINS
      });
      
      var group1 = new ColorBox({
        data: DATA.groupNums.slice(0,N_G1),
        dataLabels: DATA.groups.slice(0,N_G1),
        element: document.querySelector("#group-one"),
        binDim: BINS_G1,
        colors: COLORS,
        targetDims: {width: 200, height: 200}
      });
      
      var group2 = new ColorBox({
        data: DATA.groupNums.slice(-N_G2),
        dataLabels: DATA.groups.slice(-N_G2),
        element: document.querySelector("#group-two"),
        binDim: BINS_G2,
        colors: COLORS,
        targetDims: {width: 200, height: 200}
      });
      
      
      var g1Hist = new Hist({
        data: BOOTS.group1,
        element: document.querySelector('#group-one-hist'),
        margin: {top: 40, right: 10, bottom: 30, left: 30},
        dims: {width:300, height:200},
        xLabel: 'Group 1 Bootstrap Means'
      });
      
      var g2Hist = new Hist({
        data: BOOTS.group2,
        element: document.querySelector('#group-two-hist'),
        margin: {top: 40, right: 30, bottom: 30, left: 30},
        dims: {width:300, height:200},
        xLabel: 'Group 2 Bootstrap Means'
      });
      
      var thetaHist = new Hist({
        data: BOOTS.theta,
        element: document.querySelector('#theta-hist'),
        margin: {top: 40, right: 30, bottom: 30, left: 30},
        dims: {width:400, height:300},
        xLabel: 'Bootstrap Difference In Means'
      });
      
    </script>
  </body>
</html>
